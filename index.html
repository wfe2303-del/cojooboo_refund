<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>코주부클래스 환불 시스템</title>
<style>
:root{--bg:#0b0b0c;--card:#121214;--ink:#e5e7eb;--muted:#9ca3af;--line:#23252c;--accent:#e11d2a;--ok:#10b981}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1000px;margin:0 auto;padding:20px}
header{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;margin-bottom:12px}
.brand{display:flex;gap:10px;align-items:center}.pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
nav{display:flex;gap:8px}nav a{padding:8px 12px;border:1px solid var(--line);border-radius:10px;color:var(--ink);text-decoration:none}
nav a[aria-current="page"]{background:var(--card)}
.icon-btn{display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:12px;border:1px solid var(--line);background:#121214;cursor:pointer}
.icon-btn svg{width:20px;height:20px;fill:currentColor;color:var(--ink)}
.card{background:#121214;border:1px solid var(--line);border-radius:16px;padding:18px}
.grid{display:grid;gap:16px}.g2{grid-template-columns:1fr 1fr}.row{display:flex;gap:12px;align-items:center}
label{display:block;margin-bottom:6px;color:var(--muted);font-size:13px}
input,select,textarea{width:100%;background:#0e0f12;color:#fff;border:1px solid var(--line);border-radius:10px;padding:12px;font-size:14px}
textarea{min-height:120px;resize:vertical}button{background:var(--accent);color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
button.secondary{background:transparent;border:1px solid var(--line)}.hint{font-size:12px;color:var(--muted)}.mono{font-family:ui-monospace,Menlo,Consolas,monospace}
.table{width:100%;border-collapse:collapse}.table th,.table td{border-bottom:1px solid var(--line);padding:10px;vertical-align:top}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}.right{margin-left:auto}
.err{color:#fda4af}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand"><div class="pill">코주부클래스</div><h1 style="margin:0;font-size:20px">환불 시스템</h1></div>
    <nav><a href="#/apply" id="nav-apply">신청</a><a href="#/status" id="nav-status">승인확인</a></nav>
    <button id="adminBtn" class="icon-btn" title="관리자">
      <svg viewBox="0 0 24 24"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Zm8.94-2.88-.94-.54c.05-.35.08-.71.08-1.08s-.03-.73-.08-1.08l.94-.54a.75.75 0 0 0 .27-1.02l-1-1.73a.75.75 0 0 0-1.01-.27l-.94.54a7.77 7.77 0 0 0-1.87-1.08l-.14-1.09A.75.75 0 0 0 14.5 2h-2a.75.75 0 0 0-.74.64l-.14 1.09c-.68.26-1.31.62-1.87 1.08l-.94-.54a.75.75 0 0 0-1.01.27l-1 1.73a.75.75 0 0 0 .27 1.02l.94.54c-.05.35-.08.71-.08 1.08s.03.73.08 1.08l-.94.54a.75.75 0 0 0-.27 1.02l1-1.73c.21.36.66.48 1.01.27l.94-.54c.56.46 1.19.82 1.87 1.08l.14 1.09c.05.37.37.64.74.64h2c.37 0 .68-.27.74-.64l.14-1.09c.68-.26 1.31-.62 1.87-1.08l.94.54c.36.21.8.09 1.01-.27l1-1.73a.75.75 0 0 0-.27-1.02Z"/></svg>
    </button>
  </header>
  <main id="view"></main>
</div>

<!-- Firebase SDKs (v10+) -->
<script type="module">
/* 1) 여기를 본인 프로젝트로 교체 */
const firebaseConfig = {
  apiKey: "AIzaSyBg3l_O1lOtFSuL7zWxKXyMKhMLgC0Taeo",
  authDomain: "cjb-refunds-test.firebaseapp.com",
  databaseURL: "https://cjb-refunds-test-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "cjb-refunds-test",
  appId: "1:285202567691:web:b88f29bb59109e6959ad0e"
};
/* 2) 관리자 로그인 메일(콘솔에서 만든 계정) */
const ADMIN_EMAIL = "wfe2303@classaround.co.kr";

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, get, update, onValue, query, orderByChild, limitToLast, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* 공통 */
const $=(s,h=document)=>h.querySelector(s);
const $$=(s,h=document)=>Array.from(h.querySelectorAll(s));
const toast=m=>{const t=document.createElement('div');t.textContent=m;Object.assign(t.style,{position:'fixed',bottom:'16px',left:'50%',transform:'translateX(-50%)',background:'#1f2937',color:'#e5e7eb',border:'1px solid #374151',padding:'10px 14px',borderRadius:'10px',zIndex:9999});document.body.appendChild(t);setTimeout(()=>t.remove(),1800)};
const digits=s=>String(s||'').replace(/\D/g,'');
const payLabel=v=>/현금|cash/i.test(v)?'현금결제':'카드결제';
const phone10=raw=>{const d=digits(raw);return (d.length===11&&d.startsWith('0'))?d.slice(1):d;};
const makeKey=(course,name,ph10,pay)=>`${course.trim().toLowerCase()}|${name.trim().toLowerCase()}|${ph10}|${payLabel(pay)}`.toLowerCase();

function setActive(){const h=location.hash||'#/apply';for(const id of['nav-apply','nav-status']) $('#'+id).removeAttribute('aria-current'); if(h.startsWith('#/apply')) $('#nav-apply').setAttribute('aria-current','page'); if(h.startsWith('#/status')) $('#nav-status').setAttribute('aria-current','page');}
function nav(){const base=(location.hash||'#/apply').split('?')[0]; setActive(); ({'#/apply':renderApply,'#/status':renderStatus,'#/admin':renderAdmin}[base]||renderApply)();}
addEventListener('hashchange', nav); $('#adminBtn').addEventListener('click',()=>location.hash='#/admin');

/* -------- Apply -------- */
async function renderApply(){
  let courses=['부업 입문 강의','부동산 기초','AI 디자인 마스터'];
  let reasons=['일정 변경/개인 사유','콘텐츠 불만족','중복 결제','결제 오류','기타(직접 입력)'];
  let policy='<p>환불 규정 예시입니다. 관리자에서 수정하세요.</p>';
  onValue(ref(db,'/config'), snap=>{const c=snap.val()||{}; courses=c.courses||courses; reasons=c.reasons||reasons; policy=c.policy||policy; draw();},{onlyOnce:true});

  function draw(){
    $('#view').innerHTML=`
      <section class="card grid">
        <div><h2 style="margin:0 0 6px">코주부클래스 환불 신청</h2><p class="hint">제출 즉시 <b>승인 대기</b> 상태가 됩니다. 제출 후 자동으로 승인확인 화면으로 이동합니다.</p></div>
        <div class="grid g2">
          <div><label>수강 중인 강의</label><select id="course">${courses.map(c=>`<option>${c}</option>`).join('')}</select></div>
          <div><label>결제 수단</label><select id="pay"><option value="card">카드결제</option><option value="cash">현금결제</option></select></div>
        </div>
        <div class="grid g2">
          <div><label>이름</label><input id="name" placeholder="홍길동"></div>
          <div><label>전화번호</label><input id="phone" placeholder="010-1234-5678" inputmode="numeric"></div>
        </div>
        <div class="grid">
          <div><label>환불 사유</label><select id="reason">${reasons.map(r=>`<option>${r}</option>`).join('')}</select></div>
          <div id="reasonOtherWrap" style="display:none"><label>기타 사유 상세</label><textarea id="reasonOther" placeholder="상세 사유를 작성해 주세요"></textarea></div>
        </div>
        <div><details><summary>환불 규정 확인하기</summary><div style="margin-top:10px">${policy}</div></details></div>
        <div class="row"><button id="submit">환불 신청서 제출</button></div>
      </section>`;
    $('#reason').addEventListener('change',e=>$('#reasonOtherWrap').style.display=e.target.value.includes('기타')?'block':'none');
    $('#submit').addEventListener('click',submit);
  }

  async function submit(){
    const course=$('#course').value.trim();
    const name=$('#name').value.trim();
    const phone=$('#phone').value;
    const pay=$('#pay').value;
    const reason=$('#reason').value;
    const reasonOther=$('#reasonOther').value.trim();
    if(!course) return toast('강의를 선택해 주세요');
    if(!name) return toast('이름을 입력해 주세요');
    const ph10=phone10(phone);
    if(ph10.length!==10) return toast('전화번호를 정확히 입력해 주세요');
    const key=makeKey(course,name,ph10,pay);

    // 미리 존재 확인(중복)
    const pubSnap=await get(ref(db,`/public/${key}`));
    if (pubSnap.exists()){
      sessionStorage.setItem('lastKey', key);
      location.hash='#/status';
      return;
    }

    // 원자적 멀티경로 업데이트(생성만 허용되도록 Rules 설정되어 있음)
    const now=Date.now();
    const base={
      course,name,phone10:ph10,pay:payLabel(pay),
      reason,reasonOther,status:'승인중',receiptUrl:'',createdAt:now
    };
    const updates={};
    updates[`/submissions/${key}`]=base;
    updates[`/public/${key}`]={status:'승인중',receiptUrl:''};
    try{
      await update(ref(db), updates);
      sessionStorage.setItem('lastKey', key);
      location.hash='#/status';
    }catch(e){ console.error(e); toast('제출 중 오류가 발생했습니다'); }
  }
}

/* -------- Status -------- */
async function renderStatus(){
  $('#view').innerHTML=`
    <section class="card grid">
      <h2 style="margin:0">승인 상태 확인</h2>
      <div class="grid g2">
        <div><label>수강 중인 강의</label><input id="s_course" placeholder="예: 부업 입문 강의"></div>
        <div><label>결제 수단</label><select id="s_pay"><option value="card">카드결제</option><option value="cash">현금결제</option></select></div>
      </div>
      <div class="grid g2">
        <div><label>이름</label><input id="s_name" placeholder="홍길동"></div>
        <div><label>전화번호</label><input id="s_phone" placeholder="010-1234-5678" inputmode="numeric"></div>
      </div>
      <div class="row"><button id="checkBtn">상태 조회</button></div>
      <div id="result" class="grid"></div>
    </section>`;
  $('#checkBtn').onclick = async ()=>{
    const course=$('#s_course').value.trim();
    const name=$('#s_name').value.trim();
    const ph10=phone10($('#s_phone').value);
    const pay=$('#s_pay').value;
    if(!course||!name||ph10.length!==10) return $('#result').innerHTML='<p class="hint">모든 값을 정확히 입력하세요.</p>';
    const key=makeKey(course,name,ph10,pay);
    $('#result').innerHTML='<p class="hint">조회 중...</p>';
    const snap=await get(ref(db,`/public/${key}`));
    if(!snap.exists()){ $('#result').innerHTML='<p class="err">신청 내역을 찾을 수 없습니다.</p>'; return; }
    const {status,receiptUrl}=snap.val();
    const badge=status==='승인완료'?'<span class="badge" style="border-color:#14532d;color:#86efac">승인 완료</span>':'<span class="badge">승인 대기</span>';
    let html=`<div class="row"><div>상태</div><div class="right">${badge}</div></div>`;
    if(status==='승인완료'){
      html += receiptUrl?`<p>환불 영수증: <a href="${receiptUrl}" target="_blank" rel="noopener">열기</a></p>`:`<p class="hint">영수증 링크 준비 중입니다.</p>`;
    } else {
      html += `<p class="hint">관리자 승인 후 다시 확인해 주세요.</p>`;
    }
    $('#result').innerHTML=html;
  };

  // 제출 직후 자동 조회
  const lastKey=sessionStorage.getItem('lastKey');
  if(lastKey){
    const snap=await get(ref(db,`/public/${lastKey}`));
    if(snap.exists()){
      const {status,receiptUrl}=snap.val();
      const badge=status==='승인완료'?'<span class="badge" style="border-color:#14532d;color:#86efac">승인 완료</span>':'<span class="badge">승인 대기</span>';
      let html=`<div class="row"><div>상태</div><div class="right">${badge}</div></div>`;
      if(status==='승인완료'){
        html += receiptUrl?`<p>환불 영수증: <a href="${receiptUrl}" target="_blank" rel="noopener">열기</a></p>`:`<p class="hint">영수증 링크 준비 중입니다.</p>`;
      }
      $('#result').innerHTML=html;
    }
    sessionStorage.removeItem('lastKey');
  }
}

/* -------- Admin -------- */
function renderAdmin(){
  $('#view').innerHTML=`
    <section class="card grid" style="gap:18px">
      <div class="row"><h2 style="margin:0">관리자</h2><span class="right" id="authArea"></span></div>
      <div id="cfg"></div>
      <div id="list"></div>
    </section>`;

  onAuthStateChanged(auth, user=>{
    const area = $('#authArea');
    if(!user){
      area.innerHTML=`
        <input id="email" placeholder="이메일" value="${ADMIN_EMAIL}" style="max-width:220px">
        <input id="pw" type="password" placeholder="비밀번호" style="max-width:220px">
        <button class="secondary" id="loginBtn">로그인</button>`;
      $('#loginBtn').onclick = async ()=>{
        try{ await signInWithEmailAndPassword(auth,$('#email').value,$('#pw').value); }catch(e){ toast('로그인 실패'); }
      };
      $('#cfg').innerHTML='<p class="hint">로그인 후 설정을 관리할 수 있습니다.</p>';
      $('#list').innerHTML='';
      return;
    }
    // 로그인 중
    area.innerHTML=`<span class="badge mono">${user.email}</span><button class="secondary" id="logoutBtn">로그아웃</button>`;
    $('#logoutBtn').onclick = ()=>signOut(auth);

    // 설정 편집 UI + 실시간
    onValue(ref(db,'/config'), snap=>{
      const c = snap.val() || {courses:[],reasons:[],policy:''};
      $('#cfg').innerHTML=`
        <h3 style="margin:0">설정</h3>
        <div class="grid g2">
          <div>
            <h4 style="margin:0 0 6px">강의 목록</h4>
            <div class="row"><input id="newCourse" placeholder="강의 추가"><button id="addCourse">추가</button><button class="secondary" id="saveCourses">저장</button></div>
            <div id="courseList" class="grid" style="margin-top:8px"></div>
          </div>
          <div>
            <h4 style="margin:0 0 6px">환불 규정</h4>
            <textarea id="policyEdit" placeholder="HTML 가능"></textarea>
            <div class="row"><button id="savePolicy">규정 저장</button></div>
            <h4 style="margin:12px 0 6px">환불 사유</h4>
            <div class="row"><input id="newReason" placeholder="사유 추가"><button id="addReason">추가</button><button class="secondary" id="saveReasons">저장</button></div>
            <div id="reasonList" class="grid" style="margin-top:8px"></div>
          </div>
        </div>`;
      const courses=[...(c.courses||[])], reasons=[...(c.reasons||[])];
      const draw=(id,arr)=>{ const w=$(id); w.innerHTML=''; arr.forEach((v,i)=>{const d=document.createElement('div'); d.className='row'; d.innerHTML=`<span class="badge mono" style="flex:1">${v}</span><button class="secondary" data-i="${i}">삭제</button>`; w.appendChild(d);}); $$(id+' button').forEach(b=>b.onclick=e=>{arr.splice(+e.target.dataset.i,1); draw(id,arr);}); };
      draw('#courseList',courses); draw('#reasonList',reasons);
      $('#policyEdit').value=c.policy||'';
      $('#addCourse').onclick=()=>{const v=$('#newCourse').value.trim(); if(!v) return; courses.push(v); $('#newCourse').value=''; draw('#courseList',courses);};
      $('#saveCourses').onclick=()=>set(ref(db,'/config/courses'),courses).then(()=>toast('저장됨')).catch(()=>toast('오류'));
      $('#addReason').onclick=()=>{const v=$('#newReason').value.trim(); if(!v) return; reasons.push(v); $('#newReason').value=''; draw('#reasonList',reasons);};
      $('#saveReasons').onclick=()=>set(ref(db,'/config/reasons'),reasons).then(()=>toast('저장됨')).catch(()=>toast('오류'));
      $('#savePolicy').onclick=()=>set(ref(db,'/config/policy'),$('#policyEdit').value).then(()=>toast('저장됨')).catch(()=>toast('오류'));
    });

    // 신청자 목록(실시간, 최신 200개)
    $('#list').innerHTML=`
      <h3 style="margin:0">신청자 목록</h3>
      <div class="card" style="background:#0e0f12">
        <table class="table"><thead><tr><th>Key</th><th>강의</th><th>이름</th><th>전화</th><th>결제</th><th>사유</th><th>상태</th><th>영수증</th><th>저장</th></tr></thead><tbody id="tbody"></tbody></table>
      </div>`;
    onValue(query(ref(db,'/submissions'), orderByChild('createdAt'), limitToLast(200)), snap=>{
      const tbody = $('#tbody'); tbody.innerHTML='';
      const data = snap.val() || {};
      // 최신순으로 보이게 정렬
      const rows = Object.entries(data).sort((a,b)=> (b[1].createdAt||0)-(a[1].createdAt||0));
      for(const [key, it] of rows){
        const tr=document.createElement('tr');
        const reasonText = it.reason ? (it.reasonOther ? `${it.reason} - ${it.reasonOther}` : it.reason) : '';
        tr.innerHTML=`
          <td class="mono" style="max-width:180px">${key}</td>
          <td>${it.course||''}</td>
          <td>${it.name||''}</td>
          <td class="mono">${it.phone10||''}</td>
          <td>${it.pay||''}</td>
          <td style="max-width:240px">${reasonText}</td>
          <td><select data-k="status"><option value="승인중" ${it.status==='승인중'?'selected':''}>승인중</option><option value="승인완료" ${it.status==='승인완료'?'selected':''}>승인완료</option></select></td>
          <td style="min-width:220px"><input data-k="receiptUrl" placeholder="https://..." value="${it.receiptUrl||''}"></td>
          <td><button class="secondary" data-act="save">저장</button></td>`;
        tr.dataset.key = key; tbody.appendChild(tr);
      }
      $$('#tbody button[data-act="save"]').forEach(btn=>btn.onclick= async e=>{
        const tr=e.target.closest('tr'); const key=tr.dataset.key;
        const status=$('select[data-k="status"]',tr).value;
        const receiptUrl=$('input[data-k="receiptUrl"]',tr).value.trim();
        try{
          await update(ref(db,`/submissions/${key}`),{status,receiptUrl});
          await update(ref(db,`/public/${key}`),{status,receiptUrl: status==='승인완료'?receiptUrl:''});
          toast('저장되었습니다');
        }catch(err){ toast('오류'); }
      });
    });
  });
}

if(!location.hash) location.hash='#/apply';
nav();
</script>
</body>
</html>
